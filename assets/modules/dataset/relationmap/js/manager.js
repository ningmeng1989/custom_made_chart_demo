/*!***********************************************
 Copyright (c) 2016, Neusoft Inc.
 All rights reserved
 SaCa DataViz Version 3.1.0
 ************************************************/
dojo.require("dojox.gfx"),dojo.require("dojox.gfx.move"),dojo.require("dojox.gfx.utils");var _semantics_diagram_DiagramLayoutManager_cls={_datasetId:null,_name:null,_category:null,_remarks:null,_entityViewers:null,_width:null,_height:null,_surface:null,_node:null,_sets:null,_relation:null,relationViews:null,_fieldComputeInfos:null,excludeField:[],constructor:function(t){this._entityViewers={},this.relationViews={},this._sets=[],this._relation=[],this._fieldComputeInfos=[],this._initGfx(t)},destroy:function(){dojo.forEach(this.relationViews,function(t){t.destroy()}),dojo.forEach(this._entityViewers,function(t){t.destroy()}),this._surface.removeShape(),dojo.forEach(this._topics,dojo.unsubscribe)},setDatasetId:function(t){this._datasetId=t},setDatasetName:function(t){this._name=t},setDatasetRemarks:function(t){this._remarks=t},setDatasetCategory:function(t){this._category=t},load:function(t){this._datasetId=t.id,this._name=t.name,this._category=t.category,this._remarks=t.remarks;var e=this._sets,i=this._relation,s=this._fieldComputeInfos;t.dsEntities.forEach(function(t){var i=new semantics.diagram.InfoSet(t);e.push(i)}),t.dataSetFields.forEach(function(t){var i=new semantics.diagram.ComputeItem(t);s.push(i);for(var a in e)for(var n in e[a].items)e[a].id+"."+e[a].items[n].id==i.id&&(e[a].items[n].checked=!0)}),dojo.publish("/semantics/computeItemsAdded",[s]),t.entityRelations.forEach(function(t){var e=new semantics.diagram.Relation(t);i.push(e)})},_initGfx:function(t){var e=dojo.byId(t),i=dojo.coords(e,!0);this.x=i.x,this.y=i.y,this._node=e,this._width=i.w-17,this._height=i.h-17,this._surface=dojox.gfx.createSurface(e,this._width,this._height),this._surface=this._surface.createGroup().moveToBack(),dojo.connect(e,"onclick",this,this.clickCancel),this._topics=[],this._topics.push(dojo.subscribe("/semantics/addRelation",this,this.addRelation)),this._topics.push(dojo.subscribe("/semantics/deleteRelation",this,this.deleteRelation)),this._topics.push(dojo.subscribe("/semantics/deleteInfoSet",this,this.deleteInfoSet)),this._topics.push(dojo.subscribe("/semantics/addComputeItem",this,this.addComputeItem)),this._topics.push(dojo.subscribe("/semantics/addTableItems",this,this.addTableItems)),this._topics.push(dojo.subscribe("/semantics/removeComputeItem",this,this.removeComputeItem)),this._topics.push(dojo.subscribe("/semantics/adjustSetCheckStatus",this,this.adjustSetCheckStatus))},clickCancel:function(){dojo.publish("/semantics/clickCancel",[])},deleteInfoSet:function(t){for(var e=0;e<this._sets.length;e++)if(this._sets[e].id==t){this._sets.splice(e,1);break}0==this._sets.length&&dojo.publish("/semantics/datasetEmpty",[]),this._entityViewers[t].destroy(),delete this._entityViewers[t];for(var e=0;e<this._relation.length;e++)if(this._relation[e].entityA==t||this._relation[e].entityB==t){var i=this._relation[e].entityA+"-"+this._relation[e].entityB;this._relation.splice(e--,1),this.relationViews[i].destroy(),delete this.relationViews[i]}for(var e=0;e<this._fieldComputeInfos.length;e++){var s=this._fieldComputeInfos[e].id.split(".");if(2==s.length&&s[0]==t){var a=this._fieldComputeInfos[e];this._fieldComputeInfos.splice(e--,1),dojo.publish("/semantics/computeItemRemoved",[a])}}},deleteRelation:function(t,e,i){for(var s=0;s<this._relation.length;s++)if(this._relation[s].entityA==t&&this._relation[s].entityB==e){this._relation.splice(s,1);break}this.relationViews[i].destroy(),delete this.relationViews[i]},toAddComputeItem:function(t){this._fieldComputeInfos.push(t)},addTableItems:function(t){for(var e in t){for(var i=t[e],s=!1,e=0;e<this._fieldComputeInfos.length;e++)if(i.setId+"."+i.id==this._fieldComputeInfos[e].id){s=!0;break}if(!s){var a=new semantics.diagram.ComputeItem({id:i.setId+"."+i.id,name:_.isEmpty(i.name)?i.id:i.name,fieldRole:null,dataType:i.dataType,formula:i.setId+"."+i.id});a.name.match(/^[\w\u4e00-\u9fa5\|\-]+$/)||(a.name="未定义");for(var n=0,o=0,r="",e=0;e<a.name.length;e++){if(o=a.name.charCodeAt(e)>255?2:1,!(30>=n+o)){a.name=r;break}n+=o,r+=a.name[e]}var d=!1,h=0;do{for(var l=a.name+(0==h?"":"_"+h),e=0;e<this._fieldComputeInfos.length;e++)if(l==this._fieldComputeInfos[e].name){d=!0,h++;break}d=!1}while(d);h>0&&(a.name=a.name+"_"+h),"INTEGER"==i.dataType||"FLOAT"==i.dataType?a.fieldRole="number":"DATETIME"==i.dataType?a.fieldRole="datetime":a.fieldRole="string",this._fieldComputeInfos.push(a),dojo.publish("/semantics/computeItemAdded",[a])}}},addComputeItem:function(t){for(var e=0;e<this._fieldComputeInfos.length;e++)if(t.setId+"."+t.id==this._fieldComputeInfos[e].id)return;var i=new semantics.diagram.ComputeItem({id:t.setId+"."+t.id,name:_.isEmpty(t.name)?t.id:t.name,fieldRole:null,dataType:t.dataType,formula:t.setId+"."+t.id});"INTEGER"==t.dataType||"FLOAT"==t.dataType?i.fieldRole="number":"DATETIME"==t.dataType?i.fieldRole="datetime":i.fieldRole="string",this._fieldComputeInfos.push(i),dojo.publish("/semantics/computeItemAdded",[i])},removeComputeItem:function(t){this._entityViewers[t.setId].itemsViewer.itemViewers[t.id].changeChecked(!1);for(var e=0;e<this._fieldComputeInfos.length;e++)if(this._fieldComputeInfos[e].id==t.setId+"."+t.id){var i=this._fieldComputeInfos[e];this._fieldComputeInfos.splice(e,1),dojo.publish("/semantics/computeItemRemoved",[i]);break}},toRemoveComputeItem:function(t){var e=t.id.split(".");if(2==e.length&&this._entityViewers[e[0]])this._entityViewers[e[0]].itemsViewer.itemViewers[e[1]].toRemoveComputeItem();else for(var i=0;i<this._fieldComputeInfos.length;i++)if(this._fieldComputeInfos[i].id==t.id){var s=this._fieldComputeInfos[i];this._fieldComputeInfos.splice(i,1),dojo.publish("/semantics/computeItemRemoved",[s]);break}},updateComputeItem:function(t){for(var e=0;e<this._fieldComputeInfos.length;e++)if(this._fieldComputeInfos[e].id==t.id){this._fieldComputeInfos[e]=t;break}},adjustSetCheckStatus:function(t){for(var e in this._sets)if(this._sets[e].id==t){this.isItemsAllComputed(this._sets[e])?this._entityViewers[t].changeHeaderChecked(!0):this._entityViewers[t].changeHeaderChecked(!1);break}},isItemsAllComputed:function(t){for(var e=0;e<t.items.length;e++)if(!this.isItemComputed(t.items[e]))return!1;return!0},isItemComputed:function(t){for(var e=0;e<this._fieldComputeInfos.length;e++)if(this._fieldComputeInfos[e].id==t.setId+"."+t.id)return!0;return!1},isExistTable:function(t,e){var i=t-this.x,s=e-this.y,a=25;for(var n in this._sets){var o=this._sets[n].viewer.getLocation().dx,r=this._sets[n].viewer.getLocation().dy;if(Math.sqrt(Math.pow(i-o,2)+Math.pow(s-r,2))<=a)return!0}return!1},addDataTable:function(t){var e=new semantics.diagram.InfoSet(t),i=null;for(var s in this._sets){if(this._sets[s].id==e.id)return void this._entityViewers[e.id].infoSetSelected();for(var a in this._sets[s].items){if(this.excludeField.indexOf(this._sets[s].items[a].id)<0)for(var n in e.items)this._sets[s].items[a].id==e.items[n].id&&(i?i.relationDetails.push({fieldA:this._sets[s].items[a].id,fieldB:e.items[n].id,type:"="}):i=new semantics.diagram.Relation({entityA:this._sets[s].id,entityB:e.id,type:"inner",fieldRelations:[{fieldA:this._sets[s].items[a].id,fieldB:e.items[n].id,type:"="}]}));if(i)break}}this._sets.push(e),this._entityViewers[e.id]=e.show({surface:this._surface.createGroup(),x:e.x-this.x,y:e.y-this.y},this),i&&(this._relation.push(i),this.addRelationView(i)),this._entityViewers[e.id].infoSetSelected()},addRelation:function(t,e){for(var i=null,s=t.id,a=e.id,n=0;n<this._relation.length;n++)if(this._relation[n].entityA==s&&this._relation[n].entityB==a||this._relation[n].entityA==a&&this._relation[n].entityB==s){i=this._relation[n];break}if(null==i)i=new semantics.diagram.Relation({entityA:s,entityB:a,type:"inner",relationDetails:[]}),this._relation.push(i),this.addRelationView(i),dojo.publish("/semantics/addRelationEdit",[t,e,i]);else{var o;o=i.entityA==s?s+"-"+a:a+"-"+s}},addRelationCancel:function(t){var e=t.entityA,i=t.entityB,s=e+"-"+i;this.deleteRelation(e,i,s)},updateRelation:function(t){for(var e=t.entityA,i=t.entityB,s=e+"-"+i,a=0;a<this._relation.length;a++)if(this._relation[a].entityA==e&&this._relation[a].entityB==i){this._relation[a]=t;break}this.relationViews[s].refresh(t)},updateTableName:function(t){for(var e in this._sets)if(t.id==this._sets[e].id){this._sets[e].name=t.name;break}this._entityViewers[t.id].updateName(t.name)},addRelationView:function(t){var e=this._entityViewers[t.entityA],i=this._entityViewers[t.entityB],s=t.entityA+"-"+t.entityB;this.relationViews[s]=new semantics.diagram.RelationViewer(s,e,i,t,this._surface)},layout:function(){for(var t=this._sets,e=this._relation,i=0;i<t.length;i++){var s=this._surface.createGroup(),a=t[i];this._entityViewers[a.id]=a.show({surface:s,x:a.x,y:a.y},this)}for(var i=0;i<e.length;i++)this.addRelationView(e[i])},getDataSet:function(){var t={};t.id=this._datasetId,t.name=this._name,t.category=this._category,t.remarks=this._remarks,t.filterConditions=[],t.dsEntities=[],t.dataSetFields=[],t.entityRelations=[];for(var e in this._sets){var i={};i.id=this._sets[e].id,i.name=this._sets[e].name,i.dataSourceId=this._sets[e].dataSourceId,i.x=this._sets[e].viewer.getLocation().dx,i.y=this._sets[e].viewer.getLocation().dy,i.showItems=this._sets[e].showItems,i.fields=[];for(o in this._sets[e].items){var s={};s.id=this._sets[e].items[o].id,s.name=this._sets[e].items[o].name,s.dataType=this._sets[e].items[o].dataType,s.dsDataType=this._sets[e].items[o].fieldType,i.fields.push(s)}t.dsEntities.push(i)}for(var e=0;e<this._fieldComputeInfos.length;e++){var a={};a.id=this._fieldComputeInfos[e].id,a.fieldRole=this._fieldComputeInfos[e].fieldRole,a.formula=this._fieldComputeInfos[e].formula,a.name=this._fieldComputeInfos[e].name,a.dataType=this._fieldComputeInfos[e].type,t.dataSetFields.push(a)}for(var e=0;e<this._relation.length;e++){var n={};n.entityA=this._relation[e].entityA,n.entityB=this._relation[e].entityB,n.type=this.relationViews[n.entityA+"-"+n.entityB]._joinType,n.fieldRelations=[];for(var o=0;o<this._relation[e].relationDetails.length;o++){var r={};r.fieldA=this._relation[e].relationDetails[o].fieldA,r.fieldB=this._relation[e].relationDetails[o].fieldB,r.type=this._relation[e].relationDetails[o].type,n.fieldRelations.push(r)}t.entityRelations.push(n)}return t},snapshot:function(t){dojox.gfx.utils.toSvg(this._surface.getParent()).then(t)},clear:function(){if(this._entityViewers){for(var t in this._entityViewers)this._entityViewers[t].destroy();this._surface=this._surface.clear(),this._entityViewers={}}}};dojo.declare("semantics.diagram.DiagramLayoutManager",null,_semantics_diagram_DiagramLayoutManager_cls);