/*!***********************************************
 Copyright (c) 2016, Neusoft Inc.
 All rights reserved
 SaCa DataViz Version 3.1.0
 ************************************************/
angular.module("app.simpleconditions.datetimecondition",["dataviz.slider"]).factory("datetimeConditionService",["$http","$q",function(e,t){return{getRange:function(n){var i=t.defer();return e({method:"POST",url:charts_server+"/service/filtercondition/daterange",data:angular.toJson({field:n,dataset:null},!0)}).success(function(e){e.error?i.reject(e):i.resolve(e)}).error(function(e){i.reject(e)}),i.promise}}}]).directive("datetimecondition",["$timeout","datetimeConditionService","toaster",function(e,t,n){function i(e){var t=e.getFullYear(),n=e.getMonth()+1,i=e.getDate(),a=e.getHours(),m=e.getMinutes(),r=e.getSeconds();return n>=1&&9>=n&&(n="0"+n),i>=0&&9>=i&&(i="0"+i),a>=0&&9>=a&&(a="0"+a),m>=0&&9>=m&&(m="0"+m),r>=0&&9>=r&&(r="0"+r),t+"-"+n+"-"+i+" "+a+":"+m+":"+r}return{restrict:"AE",scope:{model:"=",refreshData:"&"},templateUrl:"modules/simpleconditions/simplecondition/datetimecondition/datetimecondition.html",link:function(a){function m(){a.lastAddTime=new Date,e(function(){(new Date).getTime()-a.lastAddTime.getTime()>=300&&a.refreshData()},300)}if(a.relativeTypes=[{id:"year",name:"年"},{id:"quarter",name:"季"},{id:"month",name:"月"},{id:"week",name:"周"},{id:"day",name:"天"},{id:"hour",name:"时"},{id:"minute",name:"分"},{id:"second",name:"秒"}],a.rangeTime={start:0,end:0},a.startTime={datetime:0},a.endTime={datetime:0},"relativeTime"==a.model.context.type)for(var r in a.relativeTypes)if(a.model.context.relativeTime.type==a.relativeTypes[r].id){a.currentType=a.relativeTypes[r];break}"rangeTime"!=a.model.context.type&&"startTime"!=a.model.context.type&&"endTime"!=a.model.context.type||t.getRange(a.model.field).then(function(e){a.range=e.object,"rangeTime"==a.model.context.type?(a.range.min>a.model.context.rangeTime.startDateTime&&(a.range.min=a.model.context.rangeTime.startDateTime),a.range.max<a.model.context.rangeTime.endDateTime&&(a.range.max=a.model.context.rangeTime.endDateTime),a.rangeTime={start:(new Date(a.model.context.rangeTime.startDateTime)-new Date(a.range.min))/1e3,end:(new Date(a.model.context.rangeTime.endDateTime)-new Date(a.range.min))/1e3}):"startTime"==a.model.context.type?(a.range.min>a.model.context.startTime.dateTime&&(a.range.min=a.model.context.startTime.dateTime),a.startTime={datetime:(new Date(a.model.context.startTime.dateTime)-new Date(a.range.min))/1e3}):"endTime"==a.model.context.type&&(a.range.max<a.model.context.endTime.dateTime&&(a.range.max=a.model.context.endTime.dateTime),a.endTime={datetime:(new Date(a.model.context.endTime.dateTime)-new Date(a.range.min))/1e3}),a.numberRange={min:0,max:(new Date(a.range.max)-new Date(a.range.min))/1e3}},function(e){n.pop("error","提示","最大日期最小日期加载失败")}),"rangeTime"==a.model.context.type&&(a.$watch("rangeTime.start",function(e,t){if(void 0!=e&&void 0!=t&&a.range){var n=new Date(a.range.min),r=new Date(n.getTime()+1e3*e);a.model.context.rangeTime.startDateTime=i(r),m()}}),a.$watch("rangeTime.end",function(e,t){if(void 0!=e&&void 0!=t&&a.range){var n=new Date(a.range.min),r=new Date(n.getTime()+1e3*e);a.model.context.rangeTime.endDateTime=i(r),m()}})),"startTime"==a.model.context.type&&a.$watch("startTime.datetime",function(e,t){if(void 0!=e&&void 0!=t&&a.range){var n=new Date(a.range.min),r=new Date(n.getTime()+1e3*e);a.model.context.startTime.dateTime=i(r),m()}}),"endTime"==a.model.context.type&&a.$watch("endTime.datetime",function(e,t){if(void 0!=e&&void 0!=t&&a.range){var n=new Date(a.range.min),r=new Date(n.getTime()+1e3*e);a.model.context.endTime.dateTime=i(r),m()}})}}}]);