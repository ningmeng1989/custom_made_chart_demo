/*!***********************************************
 Copyright (c) 2016, Neusoft Inc.
 All rights reserved
 SaCa DataViz Version 3.1.0
 ************************************************/
angular.module("dataviz.chartedit.field",[]).constant("fieldConfig",{config:{rest:charts_server+"/chartedit/field"},model:{dimensions:{string:[{name:"分类1",hierarchy:[{name:"子分类"}]},{name:"分类2"}],time:[{name:"时间"}],map:[{name:"辽宁"}]},measures:{number:[{name:"数值1"}]}}}).service("fieldService",["$http","$q","fieldConfig",function(e,i,n){function t(t,a){var c=i.defer(),a=a||n.config;return t?(t=r(t),s=t,c.resolve(t)):e({method:"get",url:a.rest}).then(function(e){t=r(e.object),s=t,c.resolve(t)},function(e){c.reject(e)}),c.promise}function a(){return s}function r(e){var i={},n={};return i.string=[],i.time=[],i.map=[],n.number=[],!e||e.dimensions||e.measures?null:(_.each(e,function(e){switch(e.type){case c.string:i.string.push({name:e.name});break;case c.time:i.time.push({name:e.name});break;case c.map:i.map.push({name:e.name});break;case c.number:n.number.push({name:e.name})}}),{dimensions:i,measures:n})}var s={},c={string:"string",time:"time",map:"map",number:"number"};return{setModel:t,getModel:a,classifyFields:r}}]).directive("datavizCharteditField",["fieldService","$modal",function(e,i){return{restrict:"AE",scope:{config:"=?",dataset:"=?"},templateUrl:"modules/chartedit/fields/fields.html",link:function(n,t,a){n.fields,n.hierarchy={},n.accept=".dataviz-field-draggable",n.dragStart=function(e,i){e.setData("name",i.name),e.setData("type",i.type),e.setData("dataSetId",n.dataset.id)},n.drop=function(e,t){var a=e.getData();if(a.type===t.type){var r,s,c,l=a.type,m=n.fields.dimensions[l];if(t.hierarchy){if(-1!==_.indexOf(_.pluck(t.hierarchy,"name"),a.name))return;c=_.flatten([t.hierarchy,{name:a.name}])}else c=[{name:t.name},{name:a.name}];for(var o=0,d=m.length;d>o;o++)m[o].name==a.name?r=o:m[o].name==t.name&&(s=o);n.hierarchy.name=t.name+", "+a.name;var h=i.open({scope:n,controller:"hierarchy",templateUrl:"modules/chartedit/fields/hierarchyname.html",backdrop:!1,size:"sm"});h.result.then(function(e){e&&(r>s?(m.splice(r,1),m.splice(s,1),m.splice(s,0,{name:n.hierarchy.name,hierarchy:c})):(m.splice(s,1),m.splice(r,1),m.splice(r,0,{name:n.hierarchy.name,hierarchy:c})))},function(){})}},n.setHierarchyName=function(e){n.hierarchy.name=e.name;var t=i.open({scope:n,controller:"hierarchy",templateUrl:"modules/chartedit/fields/hierarchyname.html",backdrop:!1,size:"sm"});t.result.then(function(){e.name=n.hierarchy.name})},n.deleteMeasureField=function(e){n.fields.measures[e.type].splice(e.index,1)},n.deleteDimensionField=function(e){var i,t=n.fields.dimensions[e.type][e.index]&&n.fields.dimensions[e.type][e.index].hierarchy;n.fields.dimensions[e.type].splice(e.index,1),t&&(i=angular.copy(t),n.fields.dimensions[e.type]=n.fields.dimensions[e.type].concat(i))},n.$on("dataviz-field-init",function(i){n.dataset.fields.dimensions||n.dataset.fields.measures?n.fields=n.dataset.fields:n.fields=e.classifyFields(n.dataset.fields)})}}}]).directive("scroll",["$timeout",function(e){return{restrict:"A",link:function(i,n){i.scrollHeight={height:n.height()},n.slimScroll({destroy:!0}),n.slimscroll(i.scrollHeight),$(window).resize(function(){e(function(){i.scrollHeight={height:n.parent().parent().height()/2},$(n).css("height",i.scrollHeight.height),n.slimScroll({destroy:!0}),n.slimscroll(i.scrollHeight)},0)})}}}]).controller("hierarchy",["$scope","$modalInstance",function(e,i){e.form={header:"设置维度层次名称"};var n=e.hierarchy.name;e.submit=function(){i.close(!0)},e.dismiss=function(){e.hierarchy.name=n,i.close(!1)}}]);