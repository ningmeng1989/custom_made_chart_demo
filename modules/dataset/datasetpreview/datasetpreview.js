/*!***********************************************
 Copyright (c) 2016, Neusoft Inc.
 All rights reserved
 SaCa DataViz Version 3.1.0
 ************************************************/
angular.module("app.dataset.datasetpreview",["app.dataset.datasetpreview.columnrename","app.dataset.datasetpreview.fieldEdit","app.dataset.datasetpreview.customfield"]).factory("datasetpreviewService",["$http","$q",function(e,t){return{getPreviewData:function(a,i){var r=t.defer();return e({method:"POST",url:charts_server+"/service/chartdata/calculate/dataset",headers:{"X-Date":(new Date).toUTCString()},data:angular.toJson(a,!0),params:{limit:i}}).success(function(e){e.error?r.reject(e):r.resolve(e)}).error(function(e){r.reject(e)}),r.promise}}}]).directive("datasetpreview",["$rootScope","$modal","datasetpreviewService","datasetService","toaster","$timeout",function(e,t,a,i,r,l){return{restrict:"AE",scope:{config:"=",model:"=",condition:"="},templateUrl:"modules/dataset/datasetpreview/datasetpreview.html",link:function(n,o){n.showCount=20;var d=o[0].children[0].children[1].children[0];d.onscroll=function(){$("#pretbody").width(d.clientWidth+d.scrollLeft)},n.fieldlist=[];var s=[];s.push(n.$on("addColumn",function(a,i){var r=!1;if(i.name.match(/^[\w\u4e00-\u9fa5\|\-]+$/)||(r=!0),!r){for(var o=0,d=0;d<i.name.length;d++)o+=i.name.charCodeAt(d)>255?2:1;o>30&&(r=!0)}if(!r)for(var d in n.fieldlist)if(i.name==n.fieldlist[d].name){r=!0;break}if(r){var s=t.open({templateUrl:"modules/dataset/datasetpreview/columnrename/columnrename.html",controller:"fieldrenameCtrl",backdrop:!1,size:"sm",resolve:{field:function(){return angular.copy(i)},fieldlist:function(){return angular.copy(n.fieldlist)}}});s.result.then(function(e){n.fieldlist.push(e)},function(t){e.$broadcast("removeComputeItem",i)})}else n.fieldlist.push(i),n.$$phase||n.$root.$$phase||n.$apply();n.lastAddTime=new Date,l(function(){(new Date).getTime()-n.lastAddTime.getTime()>=300&&n.refreshdata()},300)})),s.push(n.$on("addColumns",function(e,t){for(var a in t)n.fieldlist.push(t[a]);l(function(){n.refreshdata()},300)})),s.push(n.$on("deleteColumn",function(e,t){for(var a=0;a<n.fieldlist.length;a++)if(n.fieldlist[a].id==t.id){n.fieldlist.splice(a,1);for(var i in n.datas)n.datas[i].splice(a,1);break}n.$$phase||n.$root.$$phase||n.$apply()})),n.changeRole=function(t,a){t.fieldRole=a;for(var i in n.fieldlist)if(t.id==n.fieldlist[i].id){n.fieldlist[i]=t;break}e.$broadcast("modifyField",t),e.$broadcast("updateComputeItem",t)},n.changeName=function(a){var i=t.open({templateUrl:"modules/dataset/datasetpreview/columnrename/columnrename.html",controller:"fieldrenameCtrl",backdrop:!1,size:"sm",resolve:{field:function(){return angular.copy(a)},fieldlist:function(){return angular.copy(n.fieldlist)}}});i.result.then(function(t){for(var a in n.fieldlist)if(t.id==n.fieldlist[a].id){n.fieldlist[a]=t,e.$broadcast("updateComputeItem",t);break}},function(e){console.log(e)})},n.deleteField=function(t){e.$broadcast("removeComputeItem",t)},n.editField=function(a){var i=null;a.id.split(".").length>1?i=t.open({templateUrl:"modules/dataset/datasetpreview/fieldedit/fieldedit.html",controller:"fieldEditCtrl",backdrop:!1,size:"sm",resolve:{field:function(){return angular.copy(a)},fieldlist:function(){return angular.copy(n.fieldlist)}}}):(e.$broadcast("getCurrentDataSet",""),i=t.open({templateUrl:"modules/dataset/datasetpreview/fieldedit/customfield/customfield.html",controller:"customfieldCtrl",backdrop:!1,resolve:{field:function(){return angular.copy(a)},fieldlist:function(){return angular.copy(n.fieldlist)}}})),i.result.then(function(t){for(var a in n.fieldlist)if(t.id==n.fieldlist[a].id){n.fieldlist[a]=t,e.$broadcast("updateComputeItem",t);break}n.refreshdata()},function(e){console.log(e)})},n.addCustomField=function(){e.$broadcast("getCurrentDataSet","");var a=t.open({templateUrl:"modules/dataset/datasetpreview/fieldedit/customfield/customfield.html",controller:"customfieldCtrl",windowClass:"app-modal-customfield",backdrop:!1,resolve:{field:function(){return null},fieldlist:function(){return angular.copy(n.fieldlist)}}});a.result.then(function(t){n.fieldlist.push(t),e.$broadcast("addComputeItem",t),n.refreshdata()},function(e){console.log(e)})},n.refreshdata=function(){e.$broadcast("getCurrentDataSet","");var t=i.getCurrentDataSet();i.validateDataSet(t,null)&&(t.filterConditions=n.condition,a.getPreviewData(t,n.showCount).then(function(e){var t=e.object,a=[],i={};for(var r in t)if(0==r){for(var l in t[r])for(var o in n.fieldlist)if(t[r][l]==n.fieldlist[o].name){i[o]=l;break}}else{for(var d=new Array(n.fieldlist.length),o=0;o<n.fieldlist.length;o++)d[o]=t[r][i[o]];a.push(d)}n.datas=a,n.$$phase||n.$root.$$phase||n.$apply()},function(e){r.pop("error","提示","数据加载失败")}))},n.$on("$destroy",function(){angular.forEach(s,function(e){e()})}),n.dragstart=function(e,t){e.setData("field",{id:t.id,name:t.name,type:t.fieldRole,dataSetId:""})},n.$watch("config.refreshData",function(e){e&&(n.refreshdata(),n.config.refreshData=!1)})}}}]);