/*!***********************************************
 Copyright (c) 2016, Neusoft Inc.
 All rights reserved
 SaCa DataViz Version 3.1.0
 ************************************************/
angular.module("app.dataset.datasetpreview.customfield",[]).factory("customFieldService",["$http","$q",function(e,t){return{getCalculationFormula:function(){var r=t.defer();return e({method:"GET",url:charts_server+"/service/calculationFormula"}).success(function(e){e.error?r.reject(e):r.resolve(e)}).error(function(e){r.reject(e)}),r.promise},validateFieldFormula:function(r){var o=t.defer();return e({method:"GET",url:charts_server+"/service/calculationFormula/validate",params:{formula:r}}).success(function(e){e.error?o.reject(e):o.resolve(e)}).error(function(e){o.reject(e)}),o.promise}}}]).controller("customfieldCtrl",["$scope","$modalInstance","datasetService","customFieldService","toaster","field","fieldlist",function(e,t,r,o,a,s,u){function n(t){var r=angular.element("#customFieldFormula").val(),o=r.substring(0,e.cursor.startPos),a=r.substring(e.cursor.endPos,r.length);o.endsWith("]")&&(t=", "+t);var s=o+t+a;angular.element("#customFieldFormula").val(s),angular.element("#customFieldFormula")[0].focus(),e.cursor={startPos:e.cursor.startPos+t.length,endPos:e.cursor.startPos+t.length},angular.element("#customFieldFormula")[0].selectionStart=e.cursor.startPos,angular.element("#customFieldFormula")[0].selectionEnd=e.cursor.endPos}function l(t){var r=angular.element("#customFieldFormula").val(),o=r.substring(0,e.cursor.startPos),a=r.substring(e.cursor.endPos,r.length),s=o+t+a;angular.element("#customFieldFormula").val(s),angular.element("#customFieldFormula")[0].focus(),e.cursor={startPos:e.cursor.startPos+t.length-1,endPos:e.cursor.startPos+t.length-1},angular.element("#customFieldFormula")[0].selectionStart=e.cursor.startPos,angular.element("#customFieldFormula")[0].selectionEnd=e.cursor.endPos}e.formulaCategories=[{value:"string",text:"字符计算",methods:[]},{value:"datetime",text:"时间计算",methods:[]},{value:"number",text:"数值计算",methods:[]}],e.cursor={startPos:0,endPos:0},s?e.customField=s:e.customField={id:Math.uuid(),name:"",fieldRole:"string",formula:""},e.dsEntities=r.getCurrentDataSet().dsEntities,o.getCalculationFormula().then(function(t){var r=t.object;for(var o in r)r[o].category==e.formulaCategories[0].value?e.formulaCategories[0].methods.push(r[o]):r[o].category==e.formulaCategories[1].value?e.formulaCategories[1].methods.push(r[o]):r[o].category==e.formulaCategories[2].value&&e.formulaCategories[2].methods.push(r[o])},function(e){a.pop("error","提示","公式类别加载异常")}),e.isOkBtnDisabled=function(){if(_.isEmpty(e.customField.name))return e.warning="*字段名称不能为空",!0;if(!e.customField.name.match(/^[\w\u4e00-\u9fa5\|\-]+$/))return e.warning="*名称只能由汉字、数字、大小写字母及'_'和'-'组成",!0;for(var t=0,r=0;r<e.customField.name.length;r++)t+=e.customField.name.charCodeAt(r)>255?2:1;if(t>30)return e.warning="*名称不能多于15个汉字或30个字符",!0;for(var r in u)if(e.customField.id!=u[r].id&&e.customField.name==u[r].name)return e.warning="*字段名称已存在",!0;return!!_.isEmpty(e.customField.fieldRole)},e.clickMethod=function(t){e.showMethod=t},e.selectMethod=function(e){var t=e["function"];l(t)},e.selectEntityField=function(e,t){var r="["+e+"].["+t+"]";n(r)},e.saveCursor=function(){e.cursor={startPos:angular.element("#customFieldFormula")[0].selectionStart,endPos:angular.element("#customFieldFormula")[0].selectionEnd}},e.fieldDragstart=function(e,t,r){e.setData("field","["+r.id+"].["+t.id+"]")},e.methodDragstart=function(e,t){e.setData("method",t["function"])},e.ondrop=function(e){var t=e.getData().field,r=e.getData().method;t?n(t):r&&l(r)},e.ok=function(){e.customField.formula=angular.element("#customFieldFormula").val(),o.validateFieldFormula(e.customField.formula).then(function(r){1==r.object?t.close(e.customField):a.pop("error","提示","字段内容验证不通过，请重新填写!")},function(e){a.pop("error","提示","字段内容验证出现异常异常，请重试!")})},e.cancel=function(){t.dismiss("cancel")}}]);